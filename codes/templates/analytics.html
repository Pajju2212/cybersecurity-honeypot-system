{% extends "layout.html" %}

{% block title %}Analytics - The Honeypot{% endblock %}
{% block page_title %}Analytics{% endblock %}

{% block content %}
<section id="main">
    <div class="container">
        <h2>Attack Analytics</h2>
        <canvas id="attackFrequencyChart" class="chart"></canvas>
        <canvas id="attackTrendChart" class="chart"></canvas>
        <div id="attackMap" class="chart"></div>
    </div>
</section>
{% endblock %}

{% block scripts %}
    <script>
        async function fetchData(url) {
            const response = await fetch(url);
            return response.json();
        }

        async function renderCharts() {
            const frequencyData = await fetchData('/api/attack_frequency');
            const trendData = await fetchData('/api/attack_trend');

            const ctxFrequency = document.getElementById('attackFrequencyChart').getContext('2d');
            new Chart(ctxFrequency, { type: 'bar', data: frequencyData, options: { scales: { y: { beginAtZero: true } } } });

            const ctxTrend = document.getElementById('attackTrendChart').getContext('2d');
            new Chart(ctxTrend, { type: 'line', data: trendData, options: { scales: { y: { beginAtZero: true } } } });
        }
        
        async function renderMap() {
            const map = L.map('attackMap').setView([20, 0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd', maxZoom: 19
            }).addTo(map);

            const attackData = await fetchData('/api/attack_locations');
            attackData.forEach(attack => {
                L.circle([attack.lat, attack.lon], {
                    color: '#00ff95', fillColor: '#00ff95', fillOpacity: 0.5, radius: 20000
                }).addTo(map)
                  .bindPopup(`<b>Attack Detected!</b><br>IP: ${attack.ip}<br>Type: ${attack.type}<br>Time: ${attack.timestamp}`);
            });
        }

        window.onload = function() {
            renderCharts();
            renderMap();
        };
    </script>
{% endblock %}